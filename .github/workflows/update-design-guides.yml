name: Update design guides translations

on:
  workflow_dispatch:
  schedule:
    - cron: 0 * * * *

permissions: write-all

env:
  LANGUAGES: 'ko es de zh fr pt ja' # Supported languages separated by space (spaces are important)

jobs:
  detect-changes:
    permissions:
      pull-requests: write
      contents: write
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.detect-changes.outputs.pr_number }}
      modified_guides: ${{ steps.detect-changes.outputs.modified_guides }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - name: Detect changes in design guides
        id: detect-changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch origin update-design-guides 2>/dev/null || true

          if git rev-parse --verify origin/update-design-guides >/dev/null 2>&1; then
            MODIFIED_GUIDES=$(git diff --name-only origin/update-design-guides...HEAD | grep -E 'src/content/design/guides/content/en/.*\.mdx$' || echo "")
          else
            MODIFIED_GUIDES=$(git diff --name-only HEAD~1 HEAD | grep -E 'src/content/design/guides/content/en/.*\.mdx$' || echo "")
          fi

          echo "modified_guides=$(echo "$MODIFIED_GUIDES" | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

          if [ -z "$MODIFIED_GUIDES" ]; then
            echo "No design guide files changed â€” skipping commit and PR creation."
            exit 0
          fi

          echo "Modified guides:"
          echo "$MODIFIED_GUIDES"

          git config user.email ""
          git config user.name "Update design guides action"
          git checkout -b update-design-guides
          git add src/content/design/guides/content/en/*.mdx

          export COMMIT_MESSAGE="docs: update design guides translations"
          git commit -m "$COMMIT_MESSAGE" || true
          git push --set-upstream origin update-design-guides --force
          gh pr create --title "$COMMIT_MESSAGE" --body "" -a "dgaponov" -a "imsitnikov" -a "vvtimofeev" 2>/dev/null || true
          PR_NUMBER=$(gh pr view --json number -q ".number")

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

  prepare-inputs:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.pr_number != '' && needs.detect-changes.outputs.pr_number != null }}
    outputs:
      modified_guides_list: ${{ steps.get-modified-files.outputs.modified_guides_list }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.detect-changes.outputs.pr_number }}/head
          fetch-depth: 2
      - name: Get modified files
        id: get-modified-files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODIFIED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E 'src/content/design/guides/content/en/.*\.mdx$' || echo "")

          JSON_OUTPUT=$(echo "$MODIFIED_FILES" | awk 'NF' | jq -R -c -s '
            split("\n") |
            map(select(length > 0)) |
            map(capture("src/content/design/guides/content/en/(?<guide>[^/]+)\\.mdx").guide)
          ')

          echo "modified_guides_list=$JSON_OUTPUT" >> $GITHUB_OUTPUT
          echo "Modified guides list: $JSON_OUTPUT"

  translations:
    needs:
      - detect-changes
      - prepare-inputs
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.pr_number != '' && needs.detect-changes.outputs.pr_number != null }}
    strategy:
      max-parallel: 1
      matrix:
        guide: ${{ fromJson(needs.prepare-inputs.outputs.modified_guides_list) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.detect-changes.outputs.pr_number }}/head
          fetch-depth: 2
      - name: Prepare inputs for ${{ matrix.guide }}
        id: prepare-inputs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GUIDE: ${{ matrix.guide }}
        run: |
          INPUT_FILE="src/content/design/guides/content/en/${GUIDE}.mdx"

          echo "Processing guide: $GUIDE"
          echo "Input file: $INPUT_FILE"

          OUTPUT_FILES=""
          for LANGUAGE in ${{ env.LANGUAGES }}; do
            OUTPUT_FILES="$OUTPUT_FILES src/content/design/guides/content/${LANGUAGE}/${GUIDE}.mdx"
          done

          echo "Output files: $OUTPUT_FILES"

          echo "input_files=$INPUT_FILE" >> $GITHUB_OUTPUT
          echo "output_files=$OUTPUT_FILES" >> $GITHUB_OUTPUT
      - name: Run translations
        uses: dgaponov/gpt-translate@master
        with:
          provider: 'openrouter'
          apikey: ${{ secrets.OPENROUTER_API_KEY }}
          model: 'google/gemini-2.5-flash-lite'
          inputFiles: ${{ steps.prepare-inputs.outputs.input_files }}
          outputFiles: ${{ steps.prepare-inputs.outputs.output_files }}
          pullRequestNumber: ${{ needs.detect-changes.outputs.pr_number }}
          languages: ${{ env.LANGUAGES }}
          commitMessage: 'translations: for design guide ${{ matrix.guide }}'
          prompt: |
            Please translate the design guide source file to {targetLanguage}. \
            Make the translation sound as natural as possible. \
            Preserve all markdown formatting, including headers, lists, and code blocks. \
            Do NOT translate: \
            - Image paths (e.g., /static/images/design/...) \
            - Component names (e.g., Button, Alert, Tooltip) \
            - Technical terms in English that are commonly used in design \
            - Property names and values (e.g., "pin", "round", "brick", "auto", "max") \
            Keep all MDX syntax unchanged. \
            Do not add html snippets or convert markdown to html.
