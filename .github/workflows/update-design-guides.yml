name: Update design guides

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/content/design/guides/content/ru/**'

permissions: write-all

env:
  LANGUAGES: 'en ko es de zh fr pt ja' # Supported languages separated by space (spaces are important)
  SOURCE_LANG: 'ru'

jobs:
  prepare-inputs:
    permissions:
      pull-requests: write
      contents: write
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      modified_guides: ${{ steps.get-modified-files.outputs.modified_guides }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get modified files
        id: get-modified-files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual trigger, get all source files
            MODIFIED_FILES=$(find src/content/design/guides/content/${{ env.SOURCE_LANG }} -name "*.mdx" | sort)
          else
            # For push events, get changed files from the commit
            MODIFIED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E 'src/content/design/guides/content/${{ env.SOURCE_LANG }}/.*\.mdx$' || echo "")
          fi

          if [ -z "$MODIFIED_FILES" ]; then
            echo "No design guide files changed â€” skipping."
            echo "modified_guides=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Prepare output with guide names for matrix strategy
          JSON_OUTPUT=$(echo "$MODIFIED_FILES" | awk 'NF' | jq -R -c -s '
            split("\n") |
            map(select(length > 0)) |
            map(capture("src/content/design/guides/content/ru/(?<guide>[^/]+)\\.mdx").guide) |
            map(select(. != null))
          ')

          echo "Modified guides: $JSON_OUTPUT"
          echo "modified_guides=$JSON_OUTPUT" >> $GITHUB_OUTPUT
      - name: Create PR branch
        id: create-pr
        if: ${{ steps.get-modified-files.outputs.modified_guides != '[]' && steps.get-modified-files.outputs.modified_guides != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email ""
          git config user.name "Update design guides action"
          
          # Check if branch exists and delete it
          git push origin --delete update-design-guides 2>/dev/null || true
          git branch -D update-design-guides 2>/dev/null || true
          
          # Create fresh branch
          git checkout -b update-design-guides
          git push --set-upstream origin update-design-guides
          
          # Create empty commit to allow PR creation
          git commit --allow-empty -m "chore: prepare for design guides translations"
          git push
          
          # Create PR
          export COMMIT_MESSAGE="docs: update design guides translations"
          gh pr create --title "$COMMIT_MESSAGE" --body "Automated translations for design guides" -a "dgaponov" -a "imsitnikov" -a "vvtimofeev" || true
          
          # Get PR number
          PR_NUMBER=$(gh pr view update-design-guides --json number -q ".number" 2>/dev/null || echo "")
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

  translations:
    needs: prepare-inputs
    runs-on: ubuntu-latest
    if: ${{ needs.prepare-inputs.outputs.pr_number != '' && needs.prepare-inputs.outputs.pr_number != null && needs.prepare-inputs.outputs.modified_guides != '[]' }}
    strategy:
      max-parallel: 1
      matrix:
        guide: ${{ fromJson(needs.prepare-inputs.outputs.modified_guides) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ needs.prepare-inputs.outputs.pr_number }}/head
          fetch-depth: 2
      - name: Prepare inputs for ${{ matrix.guide }}
        id: prepare-inputs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GUIDE: ${{ matrix.guide }}
        run: |
          SOURCE_FILE="src/content/design/guides/content/${{ env.SOURCE_LANG }}/${GUIDE}.mdx"

          echo "Processing guide: $GUIDE"
          echo "Source file: $SOURCE_FILE"

          OUTPUT_FILES=""
          for LANGUAGE in ${{ env.LANGUAGES }}; do
            OUTPUT_FILES="$OUTPUT_FILES src/content/design/guides/content/${LANGUAGE}/${GUIDE}.mdx"
          done

          echo "Output files: $OUTPUT_FILES"

          echo "input_files=$SOURCE_FILE" >> $GITHUB_OUTPUT
          echo "output_files=$OUTPUT_FILES" >> $GITHUB_OUTPUT
      - name: Run translations
        uses: dgaponov/gpt-translate@master
        with:
          provider: 'openrouter'
          apikey: ${{ secrets.OPENROUTER_API_KEY }}
          model: 'google/gemini-2.5-flash-lite'
          inputFiles: ${{ steps.prepare-inputs.outputs.input_files }}
          outputFiles: ${{ steps.prepare-inputs.outputs.output_files }}
          pullRequestNumber: ${{ needs.prepare-inputs.outputs.pr_number }}
          languages: ${{ env.LANGUAGES }}
          commitMessage: 'translations: for design guide ${{ matrix.guide }}'
          prompt: |
            Please translate the design guide source file to {targetLanguage}. \
            Make the translation sound as natural as possible. \
            This is a UI/UX design guide documentation for developers. \
            Keep all MDX component tags, code blocks, and technical terms intact. \
            Do not translate component names like Button, Alert, Dialog, etc. \
            Don't convert markdown code blocks to html!
